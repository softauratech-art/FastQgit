@using System
@using System.Collections.Generic
@using System.Globalization
@using FastQ.Data.Entities
@using FastQ.Web.Models
@model ProviderTodayViewModel
@{
    ViewBag.Title = "Provider Today";
    var walkinRows = Model.Walkins ?? new List<ProviderAppointmentRow>();
    var appointmentRows = Model.Appointments ?? new List<ProviderAppointmentRow>();
    var statusOptions = Enum.GetNames(typeof(AppointmentStatus));
    var defaultDate = (ViewBag.StartDate as string) ?? DateTime.UtcNow.ToString("yyyy-MM-dd");
    var endDate = (ViewBag.EndDate as string) ?? defaultDate;
    var actionName = (ViewContext.RouteData.Values["action"] as string) ?? "Today";
    DateTime parsedStart;
    var startDateValue = DateTime.TryParseExact(defaultDate, "yyyy-MM-dd", CultureInfo.InvariantCulture, DateTimeStyles.AssumeUniversal, out parsedStart)
        ? parsedStart.Date
        : DateTime.UtcNow.Date;
    DateTime parsedEnd;
    var endDateValue = DateTime.TryParseExact(endDate, "yyyy-MM-dd", CultureInfo.InvariantCulture, DateTimeStyles.AssumeUniversal, out parsedEnd)
        ? parsedEnd.Date
        : startDateValue;
    if (endDateValue < startDateValue)
    {
        endDateValue = startDateValue;
    }
    var rangeDays = Math.Max(1, (endDateValue - startDateValue).Days + 1);
    var prevStart = startDateValue.AddDays(-rangeDays).ToString("yyyy-MM-dd", CultureInfo.InvariantCulture);
    var prevEnd = endDateValue.AddDays(-rangeDays).ToString("yyyy-MM-dd", CultureInfo.InvariantCulture);
    var nextStart = startDateValue.AddDays(rangeDays).ToString("yyyy-MM-dd", CultureInfo.InvariantCulture);
    var nextEnd = endDateValue.AddDays(rangeDays).ToString("yyyy-MM-dd", CultureInfo.InvariantCulture);
    var showWalkins = (ViewBag.ShowWalkins as bool?) ?? true;
    var showAppointments = (ViewBag.ShowAppointments as bool?) ?? true;
}
@section Head {
    <style>
        .table-striped tbody tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.5);
        }

        .accordion-toggle {
            cursor: pointer;
        }

            .accordion-toggle.locked {
                opacity: 0.45;
            }

        .row-actions {
            display: none;
        }

            .row-actions.is-open {
                display: table-row;
            }

            .row-actions.locked {
                opacity: 0.45;
            }

                .row-actions.locked .action-bar {
                    pointer-events: none;
                }

            .row-actions td {
                padding: 0 8px 12px;
            }

        .action-bar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .table-card {
            overflow-x: auto;
        }

        .date-nav {
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: var(--font-heading);
        }

            .date-nav a {
                color: var(--accent);
                font-weight: 700;
            }

        .text-center {
            text-align: center;
        }

        .modal-backdrop.show {
            display: flex;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .modal-title {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-body {
            display: grid;
            gap: 10px;
        }

        .field-row {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 12px;
            align-items: center;
        }

        .modal-body input,
        .modal-body textarea {
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid rgba(0, 0, 0, 0.15);
            font-size: 13px;
        }

        .helper-text {
            font-size: 12px;
            color: #5b5b5b;
        }

        .table-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: end;
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .filter-group {
            display: grid;
            gap: 4px;
            min-width: 160px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: #4b4b4b;
        }

        .filter-input {
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid rgba(0, 0, 0, 0.15);
            font-size: 13px;
            background: #fff;
        }

        .date-range {
            flex-wrap: nowrap;
            align-items: center;
            white-space: nowrap;
        }

        .is-hidden {
            display: none;
        }
    </style>
}

@section PageHeader {
<div>
    <div class="topbar-title">Schedule for @Model.DateText</div>
    <div class="topbar-sub">Appointments and walk-in customers</div>
</div>
<div class="top-actions">
    <button class="icon-btn" type="button" aria-label="Notifications">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 17h5l-1.4-1.4A4 4 0 0 1 17 12.8V10a5 5 0 0 0-10 0v2.8a4 4 0 0 1-1.6 3.2L4 17h5"></path>
            <path d="M9 17a3 3 0 0 0 6 0"></path>
        </svg>
    </button>
    <button class="icon-btn" type="button" aria-label="Support">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 11a8 8 0 0 1 16 0v5"></path>
            <path d="M4 16a2 2 0 0 0 2 2h2v-5H6a2 2 0 0 0-2 2Z"></path>
            <path d="M20 16a2 2 0 0 1-2 2h-2v-5h2a2 2 0 0 1 2 2Z"></path>
        </svg>
    </button>
    <button class="icon-btn" type="button" aria-label="User menu">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="8" r="3.5"></circle>
            <path d="M5 20c1.5-4 12.5-4 14 0"></path>
        </svg>
    </button>
    <div class="search-wrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;">
            <circle cx="11" cy="11" r="7"></circle>
            <path d="M20 20l-3.5-3.5"></path>
        </svg>
        <input type="text" placeholder="Search queues, names, or status" />
    </div>
</div>
}

<div class="card note">
    <div class="date-nav">
        @*<a href="@Url.Action(actionName, "Provider", new { start = prevStart, end = prevEnd })" aria-label="Previous day">&lt;&lt;</a>*@
        @*<div>@Model.DateText</div>*@
        @*<a href="@Url.Action(actionName, "Provider", new { start = nextStart, end = nextEnd })" aria-label="Next day">&gt;&gt;</a>*@
    </div>
    @*<div class="action-bar" style="padding: 10px 0;">
            <a class="btn small primary" href="@Url.Action("Today", "Provider", new { start = defaultDate, end = endDate })">Both Appts and Walkins</a>
            <a class="btn small secondary" href="@Url.Action("Appointments", "Provider", new { start = defaultDate, end = endDate })">Appointments ONLY</a>
            <a class="btn small secondary" href="@Url.Action("Walkins", "Provider", new { start = defaultDate, end = endDate })">Walkins ONLY</a>
        </div>*@

    <div class="table-filters" data-table-filter="walkins">
        <div class="filter-group">
            <label for="walkinsStatus">Status</label>
            <select id="walkinsStatus" class="filter-input" data-filter="status">
                <option value="all">All</option>
                @foreach (var status in statusOptions)
                {
                    <option value="@status">@status</option>
                }
            </select>
        </div>
        <div class="filter-group">
            <label for="walkinsStartDate">Date</label>
            <div class="action-bar date-range">
                <button class="btn small ghost" type="button" data-date-shift="-1" data-date-target="start" aria-label="Previous day">&lt;</button>
                <input id="walkinsStartDate" class="filter-input" type="date" data-filter="start" value="@defaultDate" />
                <button class="btn small ghost" type="button" data-date-shift="1" data-date-target="start" aria-label="Next day">&gt;</button>
                <span>to</span>
                <button class="btn small ghost" type="button" data-date-shift="-1" data-date-target="end" aria-label="Previous day">&lt;</button>
                <input id="walkinsEndDate" class="filter-input" type="date" data-filter="end" value="@endDate" />
                <button class="btn small ghost" type="button" data-date-shift="1" data-date-target="end" aria-label="Next day">&gt;</button>
            </div>
        </div>
        <button class="btn small ghost" type="button" data-filter-reset="true">Reset</button>
    </div>

</div>

@if (showWalkins)
{
    <div class="card">
        <div class="card-header">
            <div>
                <div class="eyebrow">Provider</div>
                @*<h2 class="page-title">Today's Schedule</h2>*@
            </div>
            <span class="badge accent">Walk-Ins</span>
        </div>

        @*<div class="table-filters" data-table-filter="walkins">
                <div class="filter-group">
                    <label for="walkinsStatus">Status</label>
                    <select id="walkinsStatus" class="filter-input" data-filter="status">
                        <option value="all">All</option>
                        @foreach (var status in statusOptions)
                        {
                            <option value="@status">@status</option>
                        }
                    </select>
                </div>
                <div class="filter-group">
                    <label for="walkinsStartDate">Date</label>
                    <div class="action-bar date-range">
                        <button class="btn small ghost" type="button" data-date-shift="-1" data-date-target="start" aria-label="Previous day">&lt;</button>
                        <input id="walkinsStartDate" class="filter-input" type="date" data-filter="start" value="@defaultDate" />
                        <button class="btn small ghost" type="button" data-date-shift="1" data-date-target="start" aria-label="Next day">&gt;</button>
                        <span>to</span>
                        <button class="btn small ghost" type="button" data-date-shift="-1" data-date-target="end" aria-label="Previous day">&lt;</button>
                        <input id="walkinsEndDate" class="filter-input" type="date" data-filter="end" value="@endDate" />
                        <button class="btn small ghost" type="button" data-date-shift="1" data-date-target="end" aria-label="Next day">&gt;</button>
                    </div>
                </div>
                <button class="btn small ghost" type="button" data-filter-reset="true">Reset</button>
            </div>*@

        <div class="table-card">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>Start</th>
                        <th>Queue</th>
                        <th>Type of Service</th>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Status</th>
                        <th>Contact</th>
                        <th class="text-center">Expand</th>
                    </tr>
                </thead>
                <tbody>
                    @if (walkinRows.Count == 0)
                    {
                        <tr>
                            <td colspan="8" class="text-center">No walk-ins for today.</td>
                        </tr>
                    }
                    else
                    {
                        for (var i = 0; i < walkinRows.Count; i++)
                        {
                            var row = walkinRows[i];
                            var rowId = "walkin-" + row.AppointmentId.ToString(CultureInfo.InvariantCulture);
                            var rowStatus = row.Status.ToString();
                            var rowDate = row.ScheduledForUtc.ToString("yyyy-MM-dd");
                            var statusClass = row.Status == AppointmentStatus.Cancelled ? "error" : string.Empty;
                            <tr class="accordion-toggle" data-target="@rowId" data-appointment-id="@row.AppointmentId" data-src-type="W" data-status="@rowStatus" data-date="@rowDate">
                                <td>@row.StartTimeText</td>
                                <td>@row.QueueName</td>
                                <td>@row.ServiceType</td>
                                <td>@row.CustomerName</td>
                                <td>@row.Phone</td>
                                <td class="@statusClass">@row.StatusText</td>
                                <td>@row.ContactMethod</td>
                                <td class="text-center">&darr;</td>
                            </tr>
                            <tr class="row-actions" id="@rowId" data-appointment-id="@row.AppointmentId" data-src-type="W">
                                <td colspan="8">
                                    <div class="action-bar">
                                        <button class="btn small primary" type="button" data-provider-action="true" data-action="arrive" data-appointment-id="@row.AppointmentId" data-src-type="W">Check-In</button>
                                        <button class="btn small secondary" type="button" data-provider-action="true" data-action="begin" data-appointment-id="@row.AppointmentId" data-src-type="W">Start</button>
                                        <button class="btn small secondary" type="button" data-provider-action="true" data-action="end" data-appointment-id="@row.AppointmentId" data-src-type="W">End</button>
                                        <button class="btn small ghost" type="button" data-provider-action="true" data-action="transfer" data-appointment-id="@row.AppointmentId" data-src-type="W">Transfer</button>
                                        <button class="btn small ghost meeting-link" type="button"
                                                data-appointment-id="@row.AppointmentId"
                                                data-src-type="W"
                                                data-date="@row.StartDateText"
                                                data-time="@row.StartTimeText"
                                                data-title="@row.ServiceType"
                                                data-customer="@row.CustomerName"
                                                data-phone="@row.Phone">
                                            Info
                                        </button>
                                        <button class="btn small ghost" type="button" data-provider-action="true" data-action="remove" data-appointment-id="@row.AppointmentId" data-src-type="W">Remove</button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    <tr class="table-empty is-hidden">
                        <td colspan="8" class="text-center">No results match the selected filters.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <button class="btn primary" type="button">Add Customer to Queue</button>
    </div>
}

@if (showAppointments)
{
    <div class="card">
        @*<div class="table-filters" data-table-filter="appointments">
                <div class="filter-group">
                    <label for="apptStatus">Status</label>
                    <select id="apptStatus" class="filter-input" data-filter="status">
                        <option value="all">All</option>
                        @foreach (var status in statusOptions)
                        {
                            <option value="@status">@status</option>
                        }
                    </select>
                </div>
                <div class="filter-group">
                    <label for="apptStartDate">Date</label>
                    <div class="action-bar date-range">
                        <button class="btn small ghost" type="button" data-date-shift="-1" data-date-target="start" aria-label="Previous day">&lt;</button>
                        <input id="apptStartDate" class="filter-input" type="date" data-filter="start" value="@defaultDate" />
                        <button class="btn small ghost" type="button" data-date-shift="1" data-date-target="start" aria-label="Next day">&gt;</button>
                        <span>to</span>
                        <button class="btn small ghost" type="button" data-date-shift="-1" data-date-target="end" aria-label="Previous day">&lt;</button>
                        <input id="apptEndDate" class="filter-input" type="date" data-filter="end" value="@endDate" />
                        <button class="btn small ghost" type="button" data-date-shift="1" data-date-target="end" aria-label="Next day">&gt;</button>
                    </div>
                </div>
                <button class="btn small ghost" type="button" data-filter-reset="true">Reset</button>
            </div>*@

        <div class="table-card">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>Start</th>
                        <th>Queue</th>
                        <th>Type of Service</th>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Status</th>
                        <th>Contact</th>
                        <th class="text-center">Expand</th>
                    </tr>
                </thead>
                <tbody>
                    @if (appointmentRows.Count == 0)
                    {
                        <tr>
                            <td colspan="8" class="text-center">No appointments scheduled for today.</td>
                        </tr>
                    }
                    else
                    {
                        for (var i = 0; i < appointmentRows.Count; i++)
                        {
                            var row = appointmentRows[i];
                            var rowId = "appt-" + row.AppointmentId.ToString(CultureInfo.InvariantCulture);
                            var rowStatus = row.Status.ToString();
                            var rowDate = row.ScheduledForUtc.ToString("yyyy-MM-dd");
                            var statusClass = row.Status == AppointmentStatus.Cancelled ? "error" : string.Empty;
                            <tr class="accordion-toggle" data-target="@rowId" data-appointment-id="@row.AppointmentId" data-src-type="A" data-status="@rowStatus" data-date="@rowDate">
                                <td>@row.StartTimeText</td>
                                <td>@row.QueueName</td>
                                <td>@row.ServiceType</td>
                                <td>@row.CustomerName</td>
                                <td>@row.Phone</td>
                                <td class="@statusClass">@row.StatusText</td>
                                <td>@row.ContactMethod</td>
                                <td class="text-center">&darr;</td>
                            </tr>
                            <tr class="row-actions" id="@rowId" data-appointment-id="@row.AppointmentId" data-src-type="A">
                                <td colspan="8">
                                    <div class="action-bar">
                                        <button class="btn small primary" type="button" data-provider-action="true" data-action="arrive" data-appointment-id="@row.AppointmentId" data-src-type="A">Check-In</button>
                                        <button class="btn small secondary" type="button" data-provider-action="true" data-action="begin" data-appointment-id="@row.AppointmentId" data-src-type="A">Start</button>
                                        <button class="btn small secondary" type="button" data-provider-action="true" data-action="end" data-appointment-id="@row.AppointmentId" data-src-type="A">End</button>
                                        <button class="btn small ghost" type="button" data-provider-action="true" data-action="transfer" data-appointment-id="@row.AppointmentId" data-src-type="A">Transfer</button>
                                        <button class="btn small ghost meeting-link" type="button"
                                                data-appointment-id="@row.AppointmentId"
                                                data-src-type="A"
                                                data-date="@row.StartDateText"
                                                data-time="@row.StartTimeText"
                                                data-title="@row.ServiceType"
                                                data-customer="@row.CustomerName"
                                                data-phone="@row.Phone">
                                            Info
                                        </button>
                                        <button class="btn small ghost" type="button" data-provider-action="true" data-action="remove" data-appointment-id="@row.AppointmentId" data-src-type="A">Remove</button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    <tr class="table-empty is-hidden">
                        <td colspan="8" class="text-center">No results match the selected filters.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <button class="btn primary" type="button">Add New Appointment</button>
    </div>
}

<div id="meetingModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="meetingModalTitle">
    <div class="modal">
        <div class="modal-header">
            <h5 class="modal-title" id="meetingModalTitle">Meeting Details</h5>
            <button class="btn small ghost" type="button" data-modal-close="meetingModal">Close</button>
        </div>
        <div class="modal-body">
            <p>Meeting Id: <span id="mid"></span></p>
            <p>
                Meeting Date: <span id="meetingDate"></span><br />
                Meeting Time: <span id="meetingTime"></span><br />
                Title: <span id="meetingTitle"></span><br />
            </p>
            <p>Customer Info:<br /><span id="meetingCustomer"></span> | <span id="meetingPhone"></span></p>
            <div class="field-row">
                <div>WebEx URL:</div>
                <input id="mURL" type="text" value="" />
            </div>
            <div class="field-row">
                <div>Notes:</div>
                <textarea id="mNotes" rows="3"></textarea>
            </div>
            <div class="helper-text">Visible to customer</div>
        </div>
        <div class="modal-footer">
            <button class="btn ghost" type="button" data-modal-close="meetingModal">Close</button>
            <button class="btn primary" type="button" id="saveMeeting">Save Changes</button>
        </div>
    </div>
</div>

<div id="webexModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="webexModalTitle">
    <div class="modal">
        <div class="modal-header">
            <h5 class="modal-title" id="webexModalTitle">WebEx</h5>
            <button class="btn small ghost" type="button" data-modal-close="webexModal">Close</button>
        </div>
        <div class="modal-body">This will launch WebEx meeting link.</div>
    </div>
</div>

@section Scripts {
    <script>
  (function () {
    var providerActionUrl = "@Url.Action("ProviderAction", "Provider")";
    var transferUrl = "@Url.Action("TransferAppointment", "Provider")";
    var saveServiceInfoUrl = "@Url.Action("SaveServiceInfo", "Provider")";
    var currentProviderId = "@(ViewBag.ProviderId as string ?? string.Empty)";

    function postForm(url, data) {
      return fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8" },
        credentials: "same-origin",
        body: new URLSearchParams(data).toString()
      }).then(function (r) { return r.json(); });
    }

    function closeModal(id) {
      var modal = document.getElementById(id);
      if (modal) {
        modal.classList.remove("show");
      }
    }

    function openModal(id) {
      var modal = document.getElementById(id);
      if (modal) {
        modal.classList.add("show");
      }
    }

    function updateRangeAndReload(startValue, endValue) {
      if (!startValue || !endValue) {
        return;
      }
      var url = new URL(window.location.href);
      url.searchParams.set("start", startValue);
      url.searchParams.set("end", endValue);
      window.location.assign(url.toString());
    }

    function clampRange(startInput, endInput) {
      if (!startInput || !endInput || !startInput.value || !endInput.value) {
        return;
      }

      if (endInput.value < startInput.value) {
        endInput.value = startInput.value;
      }
    }

    function applyTableFilters(container) {
      if (!container) {
        return;
      }

      var statusInput = container.querySelector('[data-filter="status"]');
      var startInput = container.querySelector('[data-filter="start"]');
      var endInput = container.querySelector('[data-filter="end"]');
      var statusValue = (statusInput && statusInput.value ? statusInput.value : "").toLowerCase();
      var startValue = startInput && startInput.value ? startInput.value : "";
      var endValue = endInput && endInput.value ? endInput.value : "";
      var table = container.parentElement ? container.parentElement.querySelector("table") : null;
      if (!table) {
        return;
      }

      clampRange(startInput, endInput);
      startValue = startInput && startInput.value ? startInput.value : "";
      endValue = endInput && endInput.value ? endInput.value : "";

      table.querySelectorAll("tbody tr.accordion-toggle").forEach(function (row) {
        var rowStatus = (row.getAttribute("data-status") || "").toLowerCase();
        var rowDate = row.getAttribute("data-date") || "";
        var match = true;

        if (statusValue && statusValue !== "all" && rowStatus !== statusValue) {
          match = false;
        }
        if (startValue && rowDate < startValue) {
          match = false;
        }
        if (endValue && rowDate > endValue) {
          match = false;
        }

        row.classList.toggle("is-hidden", !match);
        var apptId = row.getAttribute("data-appointment-id");
        if (apptId) {
          document.querySelectorAll('.row-actions[data-appointment-id="' + apptId + '"]').forEach(function (detail) {
            detail.classList.toggle("is-hidden", !match);
            if (!match) {
              detail.classList.remove("is-open");
            }
          });
        }
      });

      var visibleRows = Array.prototype.filter.call(
        table.querySelectorAll("tbody tr.accordion-toggle"),
        function (row) { return !row.classList.contains("is-hidden"); }
      );
      var emptyRow = table.querySelector("tbody tr.table-empty");
      if (emptyRow) {
        emptyRow.classList.toggle("is-hidden", visibleRows.length > 0);
      }
    }

    document.querySelectorAll(".accordion-toggle").forEach(function (row) {
      row.addEventListener("click", function () {
        var targetId = row.getAttribute("data-target");
        if (!targetId) {
          return;
        }
        document.querySelectorAll(".row-actions").forEach(function (detail) {
          if (detail.id !== targetId) {
            detail.classList.remove("is-open");
          }
        });
        var target = document.getElementById(targetId);
        if (target) {
          target.classList.toggle("is-open");
        }
      });
    });

    document.querySelectorAll(".table-filters").forEach(function (container) {
      container.querySelectorAll(".filter-input").forEach(function (input) {
        input.addEventListener("change", function () { applyTableFilters(container); });
        input.addEventListener("input", function () { applyTableFilters(container); });
        if (input.getAttribute("data-filter") === "start" || input.getAttribute("data-filter") === "end") {
          input.addEventListener("change", function () {
            var startInput = container.querySelector('[data-filter="start"]');
            var endInput = container.querySelector('[data-filter="end"]');
            if (startInput && endInput) {
              clampRange(startInput, endInput);
              updateRangeAndReload(startInput.value, endInput.value);
            }
          });
        }
      });

      container.querySelectorAll("[data-date-shift]").forEach(function (btn) {
        btn.addEventListener("click", function () {
          var target = btn.getAttribute("data-date-target");
          var dateInput = target ? container.querySelector('[data-filter="' + target + '"]') : null;
          if (!dateInput || !dateInput.value) {
            return;
          }
          var parts = dateInput.value.split("-");
          if (parts.length !== 3) {
            return;
          }
          var year = parseInt(parts[0], 10);
          var month = parseInt(parts[1], 10);
          var day = parseInt(parts[2], 10);
          if (!year || !month || !day) {
            return;
          }
          var base = new Date(Date.UTC(year, month - 1, day));
          var shift = parseInt(btn.getAttribute("data-date-shift") || "0", 10);
          if (!shift) {
            return;
          }
          base.setUTCDate(base.getUTCDate() + shift);
          var nextValue = base.toISOString().slice(0, 10);
          dateInput.value = nextValue;
          var startInput = container.querySelector('[data-filter="start"]');
          var endInput = container.querySelector('[data-filter="end"]');
          if (startInput && endInput) {
            clampRange(startInput, endInput);
            updateRangeAndReload(startInput.value, endInput.value);
          }
        });
      });

      var reset = container.querySelector("[data-filter-reset]");
      if (reset) {
        reset.addEventListener("click", function () {
          var statusInput = container.querySelector('[data-filter="status"]');
          var startInput = container.querySelector('[data-filter="start"]');
          var endInput = container.querySelector('[data-filter="end"]');
          if (statusInput) {
            statusInput.value = "all";
          }
          if (startInput) {
            startInput.value = "@defaultDate";
          }
          if (endInput) {
            endInput.value = "@endDate";
          }
          applyTableFilters(container);
        });
      }

      applyTableFilters(container);
    });

    document.querySelectorAll("[data-provider-action]").forEach(function (btn) {
      btn.addEventListener("click", function (event) {
        event.preventDefault();
        event.stopPropagation();

        var appointmentId = btn.getAttribute("data-appointment-id");
        var action = (btn.getAttribute("data-action") || "").toLowerCase();
        var srcType = (btn.getAttribute("data-src-type") || "").toUpperCase();
        if (!appointmentId || !action) {
          return;
        }
        if (!srcType) {
          var sourceRow = document.querySelector('.accordion-toggle[data-appointment-id="' + appointmentId + '"]');
          if (sourceRow) {
            srcType = (sourceRow.getAttribute("data-src-type") || "").toUpperCase();
          }
        }
        if (!srcType) {
          srcType = "A";
        }

        function normalizeStatus(text) {
          return (text || "").toString().trim().toLowerCase();
        }

        function getStatusForAppointment(id) {
          var row = document.querySelector('.accordion-toggle[data-appointment-id="' + id + '"]');
          return row ? normalizeStatus(row.getAttribute("data-status")) : "";
        }

        function canAction(status, actionName) {
          var finished = status === "completed" || status === "cancelled" || status === "closedbysystem" || status === "transferredout";
          if (finished) {
            return false;
          }
          if (actionName === "arrive") {
            return status === "scheduled";
          }
          if (actionName === "begin") {
            return status === "arrived" || status === "scheduled";
          }
          if (actionName === "end") {
            return status === "inservice";
          }
          if (actionName === "remove") {
            return !finished;
          }
          return true;
        }

        var status = getStatusForAppointment(appointmentId);
        if (!canAction(status, action)) {
          window.alert("Action not allowed for the current status.");
          return;
        }

        if (action === "transfer") {
          var targetQueueId = window.prompt("Enter target QueueId (number):", "");
          if (!targetQueueId) {
            return;
          }

          postForm(transferUrl, { appointmentId: appointmentId, targetQueueId: targetQueueId })
            .then(function (res) {
              if (!res || !res.ok) {
                window.alert(res && res.error ? res.error : "Transfer failed.");
                return;
              }
              window.location.reload();
            });
          return;
        }

        postForm(providerActionUrl, { action: action, appointmentId: appointmentId, srcType: srcType })
          .then(function (res) {
            if (!res || !res.ok) {
              window.alert(res && res.error ? res.error : "Action failed.");
              return;
            }
            window.location.reload();
          });
      });
    });

    function lockAppointment(appointmentId) {
      document.querySelectorAll('[data-appointment-id="' + appointmentId + '"]').forEach(function (el) {
        el.classList.add("locked");
      });
    }

    window.onFastQAppointmentUpdated = function (appointmentId, status, providerId) {
      console.log("SignalR appointmentUpdated:", appointmentId, status, providerId, currentProviderId);
      if (providerId && currentProviderId && providerId.toLowerCase() === currentProviderId.toLowerCase()) {
        return;
      }
      var normalized = (status || "").toString().toLowerCase();
      if (normalized === "inservice" || normalized === "completed" || normalized === "cancelled") {
        lockAppointment(appointmentId);
      }
    };

    document.querySelectorAll("[data-modal-close]").forEach(function (btn) {
      btn.addEventListener("click", function () {
        closeModal(btn.getAttribute("data-modal-close"));
      });
    });

    document.querySelectorAll(".meeting-link").forEach(function (link) {
      link.addEventListener("click", function (event) {
        event.preventDefault();
        event.stopPropagation();

        var appointmentId = link.getAttribute("data-appointment-id") || "";
        var srcType = link.getAttribute("data-src-type") || "A";

        var mid = document.getElementById("mid");
        var meetingDate = document.getElementById("meetingDate");
        var meetingTime = document.getElementById("meetingTime");
        var meetingTitle = document.getElementById("meetingTitle");
        var meetingCustomer = document.getElementById("meetingCustomer");
        var meetingPhone = document.getElementById("meetingPhone");
        var urlInput = document.getElementById("mURL");
        var notesInput = document.getElementById("mNotes");

        if (mid) {
          mid.textContent = appointmentId;
          mid.setAttribute("data-appointment-id", appointmentId);
          mid.setAttribute("data-src-type", srcType);
        }
        if (meetingDate) meetingDate.textContent = link.getAttribute("data-date") || "";
        if (meetingTime) meetingTime.textContent = link.getAttribute("data-time") || "";
        if (meetingTitle) meetingTitle.textContent = link.getAttribute("data-title") || "";
        if (meetingCustomer) meetingCustomer.textContent = link.getAttribute("data-customer") || "";
        if (meetingPhone) meetingPhone.textContent = link.getAttribute("data-phone") || "";
        if (urlInput) urlInput.value = "";
        if (notesInput) notesInput.value = "";

        openModal("meetingModal");
      });
    });

    var saveMeeting = document.getElementById("saveMeeting");
    if (saveMeeting) {
      saveMeeting.addEventListener("click", function () {
        var mid = document.getElementById("mid");
        var urlInput = document.getElementById("mURL");
        var notesInput = document.getElementById("mNotes");
        if (!mid) {
          return;
        }

        var appointmentId = mid.getAttribute("data-appointment-id");
        var srcType = mid.getAttribute("data-src-type") || "A";
        var payload = {
          appointmentId: appointmentId,
          srcType: srcType,
          webexUrl: urlInput ? urlInput.value : "",
          notes: notesInput ? notesInput.value : ""
        };

        postForm(saveServiceInfoUrl, payload)
          .then(function (res) {
            if (!res || !res.ok) {
              window.alert(res && res.error ? res.error : "Save failed.");
              return;
            }
            closeModal("meetingModal");
          });
      });
    }
  })();
    </script>
}
