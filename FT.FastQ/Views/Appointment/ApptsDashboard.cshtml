@using FT.FastQ.Helpers
@using System.Linq
@model FT.FastQ.Models.ApptsDashboardViewModel
@{
    ViewBag.Title = ResourceHelper.GetResourceString("AppointmentsDashboard");
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="page-container">
    <h2>@ResourceHelper.GetResourceString("AppointmentsDashboard")</h2>
    
    <div class="tabs-container">
        <a href="@Url.Action("ApptsDashboard", "Appointment", new { viewType = "Upcoming" })" 
           class="tab-link @(Model.ViewType == "Upcoming" ? "active" : "")">
            @ResourceHelper.GetResourceString("Upcoming")
        </a>
        <a href="@Url.Action("ApptsDashboard", "Appointment", new { viewType = "History" })" 
           class="tab-link @(Model.ViewType == "History" ? "active" : "")">
            @ResourceHelper.GetResourceString("History")
        </a>
    </div>

    <div class="grid-container">
        <table class="appointments-grid">
            <thead>
                <tr>
                    <th class="sortable" data-sort="AppointmentDateTime">
                        <a href="@Url.Action("ApptsDashboard", "Appointment", new { viewType = Model.ViewType, page = Model.CurrentPage, sortBy = "AppointmentDateTime", sortDirection = Model.SortBy == "AppointmentDateTime" && Model.SortDirection == "ASC" ? "DESC" : "ASC" })" class="sort-link">
                            @ResourceHelper.GetResourceString("DateAndTime")
                            <span class="sort-indicator">
                                @if (Model.SortBy == "AppointmentDateTime")
                                {
                                    if (Model.SortDirection == "ASC")
                                    {
                                        <span class="sort-triangles">
                                            <span class="triangle-up active"></span>
                                            <span class="triangle-down"></span>
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="sort-triangles">
                                            <span class="triangle-up"></span>
                                            <span class="triangle-down active"></span>
                                        </span>
                                    }
                                }
                                else
                                {
                                    <span class="sort-triangles">
                                        <span class="triangle-up"></span>
                                        <span class="triangle-down"></span>
                                    </span>
                                }
                            </span>
                        </a>
                    </th>
                    <th class="sortable" data-sort="Queue">
                        <a href="@Url.Action("ApptsDashboard", "Appointment", new { viewType = Model.ViewType, page = Model.CurrentPage, sortBy = "Queue", sortDirection = Model.SortBy == "Queue" && Model.SortDirection == "ASC" ? "DESC" : "ASC" })" class="sort-link">
                            @ResourceHelper.GetResourceString("Queue")
                            <span class="sort-indicator">
                                @if (Model.SortBy == "Queue")
                                {
                                    if (Model.SortDirection == "ASC")
                                    {
                                        <span class="sort-triangles">
                                            <span class="triangle-up active"></span>
                                            <span class="triangle-down"></span>
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="sort-triangles">
                                            <span class="triangle-up"></span>
                                            <span class="triangle-down active"></span>
                                        </span>
                                    }
                                }
                                else
                                {
                                    <span class="sort-triangles">
                                        <span class="triangle-up"></span>
                                        <span class="triangle-down"></span>
                                    </span>
                                }
                            </span>
                        </a>
                    </th>
                    <th class="sortable" data-sort="Type">
                        <a href="@Url.Action("ApptsDashboard", "Appointment", new { viewType = Model.ViewType, page = Model.CurrentPage, sortBy = "Type", sortDirection = Model.SortBy == "Type" && Model.SortDirection == "ASC" ? "DESC" : "ASC" })" class="sort-link">
                            @ResourceHelper.GetResourceString("Type")
                            <span class="sort-indicator">
                                @if (Model.SortBy == "Type")
                                {
                                    if (Model.SortDirection == "ASC")
                                    {
                                        <span class="sort-triangles">
                                            <span class="triangle-up active"></span>
                                            <span class="triangle-down"></span>
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="sort-triangles">
                                            <span class="triangle-up"></span>
                                            <span class="triangle-down active"></span>
                                        </span>
                                    }
                                }
                                else
                                {
                                    <span class="sort-triangles">
                                        <span class="triangle-up"></span>
                                        <span class="triangle-down"></span>
                                    </span>
                                }
                            </span>
                        </a>
                    </th>
                    <th class="sortable" data-sort="Status">
                        <a href="@Url.Action("ApptsDashboard", "Appointment", new { viewType = Model.ViewType, page = Model.CurrentPage, sortBy = "Status", sortDirection = Model.SortBy == "Status" && Model.SortDirection == "ASC" ? "DESC" : "ASC" })" class="sort-link">
                            @ResourceHelper.GetResourceString("Status")
                            <span class="sort-indicator">
                                @if (Model.SortBy == "Status")
                                {
                                    if (Model.SortDirection == "ASC")
                                    {
                                        <span class="sort-triangles">
                                            <span class="triangle-up active"></span>
                                            <span class="triangle-down"></span>
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="sort-triangles">
                                            <span class="triangle-up"></span>
                                            <span class="triangle-down active"></span>
                                        </span>
                                    }
                                }
                                else
                                {
                                    <span class="sort-triangles">
                                        <span class="triangle-up"></span>
                                        <span class="triangle-down"></span>
                                    </span>
                                }
                            </span>
                        </a>
                    </th>
                    @if (Model.ViewType == "Upcoming")
                    {
                        <th>@ResourceHelper.GetResourceString("Cancel")</th>
                    }
                </tr>
            </thead>
            <tbody>
                @if (Model.Appointments != null && Model.Appointments.Any())
                {
                    int rowIndex = 0;
                    foreach (var appointment in Model.Appointments)
                    {
                        <tr class="@(rowIndex % 2 == 0 ? "even-row" : "odd-row")">
                            <td>@appointment.AppointmentDateTime.ToString("MM-dd-yyyy hh:mm tt")</td>
                            <td>@appointment.Queue</td>
                            <td>@appointment.Type</td>
                            <td>@appointment.Status</td>
                            @if (Model.ViewType == "Upcoming")
                            {
                                <td class="cancel-cell">
                                    @if (appointment.Status == "Cancelled")
                                    {
                                        <span class="cancel-link disabled">@ResourceHelper.GetResourceString("Cancel")</span>
                                    }
                                    else
                                    {
                                        <a href="@Url.Action("CancelAppt", "Appointment", new { appointmentId = appointment.Id })" class="cancel-link" onclick="event.stopPropagation();">@ResourceHelper.GetResourceString("Cancel")</a>
                                    }
                                </td>
                            }
                        </tr>
                        rowIndex++;
                    }
                }
                else
                {
                    <tr>
                        <td colspan="@(Model.ViewType == "Upcoming" ? "5" : "4")" class="no-data">
                            No appointments found.
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @if (Model.TotalPages > 1)
    {
        <div class="pagination-container">
            <div class="pagination-info">
                Showing @((Model.CurrentPage - 1) * Model.PageSize + 1) to @(Math.Min(Model.CurrentPage * Model.PageSize, Model.TotalRecords)) of @Model.TotalRecords appointments
            </div>
            <div class="pagination-controls">
                @if (Model.CurrentPage > 1)
                {
                    <a href="@Url.Action("ApptsDashboard", "Appointment", new { viewType = Model.ViewType, page = Model.CurrentPage - 1, sortBy = Model.SortBy, sortDirection = Model.SortDirection })" class="pagination-btn">Previous</a>
                }
                else
                {
                    <span class="pagination-btn disabled">Previous</span>
                }

                @for (int i = 1; i <= Model.TotalPages; i++)
                {
                    if (i == Model.CurrentPage)
                    {
                        <span class="pagination-btn active">@i</span>
                    }
                    else if (i == 1 || i == Model.TotalPages || (i >= Model.CurrentPage - 2 && i <= Model.CurrentPage + 2))
                    {
                        <a href="@Url.Action("ApptsDashboard", "Appointment", new { viewType = Model.ViewType, page = i, sortBy = Model.SortBy, sortDirection = Model.SortDirection })" class="pagination-btn">@i</a>
                    }
                    else if (i == Model.CurrentPage - 3 || i == Model.CurrentPage + 3)
                    {
                        <span class="pagination-ellipsis">...</span>
                    }
                }

                @if (Model.CurrentPage < Model.TotalPages)
                {
                    <a href="@Url.Action("ApptsDashboard", "Appointment", new { viewType = Model.ViewType, page = Model.CurrentPage + 1, sortBy = Model.SortBy, sortDirection = Model.SortDirection })" class="pagination-btn">Next</a>
                }
                else
                {
                    <span class="pagination-btn disabled">Next</span>
                }
            </div>
        </div>
    }
</div>

<style>
    .page-container {
        background: white;
        border-radius: 8px;
        padding: 20px 30px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        height: calc(100vh - 120px);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
    }

    .page-container h2 {
        color: #667eea;
        margin-bottom: 20px;
        font-size: 24px;
        flex-shrink: 0;
    }

    .tabs-container {
        display: flex;
        gap: 0;
        margin-bottom: 20px;
        border-bottom: 2px solid #ddd;
        flex-shrink: 0;
    }

    .tab-link {
        padding: 12px 24px;
        text-decoration: none;
        color: #666;
        font-weight: 500;
        font-size: 15px;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
        background: none;
        border-top: none;
        border-left: none;
        border-right: none;
    }

    .tab-link:hover {
        color: #667eea;
        background-color: #f5f5f5;
    }

    .tab-link.active {
        color: #667eea;
        border-bottom-color: #667eea;
        font-weight: 600;
    }

    .grid-container {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 5px;
    }

    .appointments-grid {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }

    .appointments-grid thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .appointments-grid th {
        padding: 12px 15px;
        text-align: left;
        font-weight: 600;
        color: white;
        font-size: 14px;
        border-bottom: 2px solid rgba(255, 255, 255, 0.2);
    }

    .appointments-grid th.sortable {
        cursor: pointer;
        user-select: none;
    }

    .appointments-grid th.sortable:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .sort-link {
        color: white;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
    }

    .sort-link:hover {
        color: white;
        text-decoration: none;
    }

    .sort-indicator {
        margin-left: 8px;
        display: inline-block;
    }

    .sort-triangles {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 2px;
        height: 16px;
    }

    .triangle-up, .triangle-down {
        width: 0;
        height: 0;
        border-left: 4px solid transparent;
        border-right: 4px solid transparent;
        opacity: 0.4;
    }

    .triangle-up {
        border-bottom: 5px solid white;
        border-top: none;
    }

    .triangle-down {
        border-top: 5px solid white;
        border-bottom: none;
    }

    .triangle-up.active, .triangle-down.active {
        opacity: 1;
    }

    .appointments-grid td {
        padding: 12px 15px;
        font-size: 14px;
        color: #333;
        border-bottom: 1px solid #eee;
    }

    .appointments-grid tbody tr.even-row {
        background-color: #f5f0ff;
    }

    .appointments-grid tbody tr.odd-row {
        background-color: #ffffff;
    }

    .appointments-grid tbody tr:hover {
        background-color: #e8dfff;
    }

    .cancel-cell {
        pointer-events: auto;
    }

    .cancel-link {
        color: #007bff;
        text-decoration: underline;
        cursor: pointer;
        font-size: 14px;
        display: inline-block;
        pointer-events: auto;
    }

    .cancel-link:hover {
        color: #0056b3;
        text-decoration: none;
    }

    .cancel-link.disabled {
        color: #999;
        text-decoration: none;
        cursor: not-allowed;
        pointer-events: none;
    }

    .no-data {
        text-align: center;
        padding: 30px;
        color: #999;
        font-style: italic;
    }

    .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        padding: 15px 0;
        border-top: 1px solid #ddd;
        flex-shrink: 0;
    }

    .pagination-info {
        color: #666;
        font-size: 14px;
    }

    .pagination-controls {
        display: flex;
        gap: 5px;
        align-items: center;
    }

    .pagination-btn {
        padding: 8px 12px;
        text-decoration: none;
        color: #667eea;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        transition: all 0.3s;
        background: white;
        min-width: 40px;
        text-align: center;
    }

    .pagination-btn:hover:not(.disabled):not(.active) {
        background-color: #f5f5f5;
        border-color: #667eea;
    }

    .pagination-btn.active {
        background-color: #667eea;
        color: white;
        border-color: #667eea;
        cursor: default;
    }

    .pagination-btn.disabled {
        color: #ccc;
        border-color: #eee;
        cursor: not-allowed;
        background-color: #f9f9f9;
    }

    .pagination-ellipsis {
        padding: 8px 4px;
        color: #999;
        font-size: 14px;
    }

    @@media (max-width: 768px) {
        .page-container {
            padding: 15px;
            height: calc(100vh - 100px);
        }

        .page-container h2 {
            font-size: 22px;
        }

        .appointments-grid {
            font-size: 12px;
        }

        .appointments-grid th,
        .appointments-grid td {
            padding: 8px 10px;
        }

        .pagination-container {
            flex-direction: column;
            gap: 15px;
            align-items: flex-start;
        }

        .pagination-controls {
            flex-wrap: wrap;
        }
    }
</style>

<script>
    $(document).ready(function () {
        // Ensure cancel links work properly and don't trigger sorting
        $('.cancel-link').on('click', function (e) {
            e.stopPropagation();
            // Allow the default link behavior to proceed
            return true;
        });

        // Prevent any table row clicks from interfering with cancel links
        $('.appointments-grid tbody tr').on('click', function (e) {
            // If clicking on a cancel link, don't do anything
            if ($(e.target).hasClass('cancel-link') || $(e.target).closest('.cancel-link').length > 0) {
                return;
            }
        });
    });
</script>

