@using System.Collections.Generic
@using FastQ.Data.Entities
@using FastQ.Web.Models
@model ProviderTodayViewModel
@{
    ViewBag.Title = "Provider Today";
    var liveRows = Model.LiveQueue ?? new List<ProviderAppointmentRow>();
    var scheduledRows = Model.Scheduled ?? new List<ProviderAppointmentRow>();
}
@section Head {
    <style>
        .table-striped tbody tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.5);
        }
        .accordion-toggle { cursor: pointer; }
        .row-actions { display: none; }
        .row-actions.is-open { display: table-row; }
        .row-actions td { padding: 0 8px 12px; }
        .action-bar { display: flex; gap: 8px; flex-wrap: wrap; }
        .table-card { overflow-x: auto; }
        .date-nav { display: flex; align-items: center; gap: 10px; font-family: var(--font-heading); }
        .date-nav a { color: var(--accent); font-weight: 700; }
        .text-center { text-align: center; }
        .modal-backdrop.show { display: flex; }
        .modal-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
        .modal-title { margin: 0; font-size: 18px; font-weight: 700; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; }
        .modal-body { display: grid; gap: 10px; }
        .field-row { display: grid; grid-template-columns: 120px 1fr; gap: 12px; align-items: center; }
    </style>
}

<div class="card">
    <div class="card-header">
        <div>
            <div class="eyebrow">Provider</div>
            <h2 class="page-title">Today's Schedule</h2>
        </div>
        <span class="badge accent">Live Queue</span>
    </div>

    <div class="table-card">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>Start</th>
                    <th>Queue</th>
                    <th>Type of Service</th>
                    <th>Name</th>
                    <th>Phone</th>
                    <th>Status</th>
                    <th>Contact</th>
                    <th class="text-center">Expand</th>
                </tr>
            </thead>
            <tbody>
                @if (liveRows.Count == 0)
                {
                    <tr>
                        <td colspan="8" class="text-center">No live appointments.</td>
                    </tr>
                }
                else
                {
                    for (var i = 0; i < liveRows.Count; i++)
                    {
                        var row = liveRows[i];
                        var rowId = "live-" + row.AppointmentId.ToString("N");
                        var statusClass = row.Status == AppointmentStatus.Cancelled ? "error" : string.Empty;
                        <tr class="accordion-toggle" data-target="@rowId">
                            <td>@row.StartTimeText</td>
                            <td>@row.QueueName</td>
                            <td>@row.ServiceType</td>
                            <td>@row.CustomerName</td>
                            <td>@row.Phone</td>
                            <td class="@statusClass">@row.StatusText</td>
                            <td>@row.ContactMethod</td>
                            <td class="text-center">&darr;</td>
                        </tr>
                        <tr class="row-actions" id="@rowId">
                            <td colspan="8">
                                <div class="action-bar">
                                    <button class="btn small primary" type="button" data-appointment-id="@row.AppointmentId">Check-In</button>
                                    <button class="btn small secondary" type="button" data-appointment-id="@row.AppointmentId">Start</button>
                                    <button class="btn small ghost" type="button" data-appointment-id="@row.AppointmentId">Transfer</button>
                                    <button class="btn small ghost" type="button" data-appointment-id="@row.AppointmentId">Info</button>
                                    <button class="btn small ghost" type="button" data-appointment-id="@row.AppointmentId">Remove</button>
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <button class="btn primary" type="button">Add Customer to Queue</button>
</div>

<div class="card note">
    <div class="date-nav">
        <a href="#" aria-label="Previous day">&lt;&lt;</a>
        <div>@Model?.DateText</div>
        <a href="#" aria-label="Next day">&gt;&gt;</a>
    </div>
</div>

<div class="card">
    <div class="table-card">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>Start</th>
                    <th>Queue</th>
                    <th>Type of Service</th>
                    <th>Name</th>
                    <th>Phone</th>
                    <th>Status</th>
                    <th>Contact</th>
                    <th class="text-center">Expand</th>
                </tr>
            </thead>
            <tbody>
                @if (scheduledRows.Count == 0)
                {
                    <tr>
                        <td colspan="8" class="text-center">No appointments scheduled for today.</td>
                    </tr>
                }
                else
                {
                    for (var i = 0; i < scheduledRows.Count; i++)
                    {
                        var row = scheduledRows[i];
                        var rowId = "sched-" + row.AppointmentId.ToString("N");
                        var statusClass = row.Status == AppointmentStatus.Cancelled ? "error" : string.Empty;
                        <tr class="accordion-toggle" data-target="@rowId">
                            <td>@row.StartTimeText</td>
                            <td>@row.QueueName</td>
                            <td>@row.ServiceType</td>
                            <td>@row.CustomerName</td>
                            <td>@row.Phone</td>
                            <td class="@statusClass">@row.StatusText</td>
                            <td>@row.ContactMethod</td>
                            <td class="text-center">&darr;</td>
                        </tr>
                        <tr class="row-actions" id="@rowId">
                            <td colspan="8">
                                <div class="action-bar">
                                    <button class="btn small primary" type="button" data-appointment-id="@row.AppointmentId">Check-In</button>
                                    <button class="btn small secondary" type="button" data-appointment-id="@row.AppointmentId">Start</button>
                                    <button class="btn small ghost" type="button" data-appointment-id="@row.AppointmentId">Transfer</button>
                                    <button class="btn small ghost" type="button" data-appointment-id="@row.AppointmentId">Info</button>
                                    <button class="btn small ghost" type="button" data-appointment-id="@row.AppointmentId">Remove</button>
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <button class="btn primary" type="button">Add New Appointment</button>
</div>

<div id="meetingModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="meetingModalTitle">
    <div class="modal">
        <div class="modal-header">
            <h5 class="modal-title" id="meetingModalTitle">Meeting Details</h5>
            <button class="btn small ghost" type="button" data-modal-close="meetingModal">Close</button>
        </div>
        <div class="modal-body">
            <p>Meeting Id: <span id="mid"></span></p>
            <p>
                Meeting Date: Oct 13, 2025<br />
                Meeting Time: 10:00 AM<br />
                Title: Building - Commercial Plans Review (Pamela ONeil)<br />
            </p>
            <p>Customer Info:<br />Pamela ONeil | pamela@example.com | 407-123-2659</p>
            <div class="field-row">
                <div>Join URL:</div>
                <input id="mURL" type="text" value="" />
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn ghost" type="button" data-modal-close="meetingModal">Close</button>
            <button class="btn primary" type="button" id="saveMeeting">Save Changes</button>
        </div>
    </div>
</div>

<div id="webexModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="webexModalTitle">
    <div class="modal">
        <div class="modal-header">
            <h5 class="modal-title" id="webexModalTitle">WebEx</h5>
            <button class="btn small ghost" type="button" data-modal-close="webexModal">Close</button>
        </div>
        <div class="modal-body">This will launch WebEx meeting link.</div>
    </div>
</div>

@section Scripts {
<script>
  (function () {
    function closeModal(id) {
      var modal = document.getElementById(id);
      if (modal) {
        modal.classList.remove("show");
      }
    }

    function openModal(id) {
      var modal = document.getElementById(id);
      if (modal) {
        modal.classList.add("show");
      }
    }

    document.querySelectorAll(".accordion-toggle").forEach(function (row) {
      row.addEventListener("click", function () {
        var targetId = row.getAttribute("data-target");
        if (!targetId) {
          return;
        }
        document.querySelectorAll(".row-actions").forEach(function (detail) {
          if (detail.id !== targetId) {
            detail.classList.remove("is-open");
          }
        });
        var target = document.getElementById(targetId);
        if (target) {
          target.classList.toggle("is-open");
        }
      });
    });

    document.querySelectorAll("[data-modal-close]").forEach(function (btn) {
      btn.addEventListener("click", function () {
        closeModal(btn.getAttribute("data-modal-close"));
      });
    });

    var meetingLink = document.querySelector(".meeting-link");
    if (meetingLink) {
      meetingLink.addEventListener("click", function (event) {
        event.preventDefault();
        var mid = document.getElementById("mid");
        if (mid) {
          mid.textContent = meetingLink.getAttribute("data-id") || "";
        }
        openModal("meetingModal");
      });
    }

    var saveMeeting = document.getElementById("saveMeeting");
    if (saveMeeting) {
      saveMeeting.addEventListener("click", function () {
        closeModal("meetingModal");
      });
    }
  })();
</script>
}

